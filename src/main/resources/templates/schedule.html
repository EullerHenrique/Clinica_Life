<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> </title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-CuOF+2SnTUfTwSZjCXf01h7uYhfOBuxIhGKPbfEJ3+FqH/s6cIFN9bGr1HmAg4fQ" crossorigin="anonymous">
  <style>

    nav, footer, .btn{
      background-color: lime;
    }

    p{
      text-align: justify;
    }

    h1, h2, footer p{
      text-align: center;
    }

    footer p{
      padding: 10px 0;
      margin: 0;
    }


    .footer{
      width: 100%;
      position: fixed;
      bottom: 0px;
    }




    /* Galeria e Login */

    nav{
      z-index: 2;
    }


    .galeria{

      position: absolute;
      left: 50%;
      top: 60%;
      transform: translate(-50%, -60%);
      z-index: 1;

    }

    div > img{
      height: 500px;
    }

    .login{

      position: absolute;
      left: 50%;
      top: 55%;
      transform: translate(-50%, -55%);
      z-index: 1;

      width: 350px;

    }


  </style>

</head>
<body>

<header>

  <!-- navbar = Criação da estrutura de uma navbar-->
  <!-- navbar-expand-sm = A barra de nabegação se expande a partir do tamanho sm-->
  <!-- navbar-light = A navbar possui um background claro, portanto, a cor dos textos é escura-->

  <nav class="navbar navbar-expand-sm navbar-light">

    <!-- container-fluid = width: 100% -->

    <div class="container-fluid">


      <!-- navbar-brand = Espaço reservado para o nome ou o logo da empresa-->

      <a class="navbar-brand" href="../pages/home.html">
        <img src="/images/foto_logo.png" alt="Clinica life" width="60" height="45" class="d-inline-block align-top">
      </a>

      <!-- navbar-toogler = Botão de recolhimento que aparece em resoluções abaixo do tamanho sm -->

      <button class="navbar-toggler shadow-none" type="button" data-toggle="collapse" data-target="#navbar">

        <!-- navbar-toogler-icon = Ícone do plugin -->
        <!-- data-toogle = Indica o efeito da ação => collapse (desabar)-->
        <!-- data-target = Alvo da ação-->

        <span class="navbar-toggler-icon"></span>
      </button>


      <!-- collapse navbar-collapse = Agrupa e oculta o conteúdo da barra de navegação de acordo com o ponto de interrupção-->

      <div class="collapse navbar-collapse" id="navbar">

        <!-- navbar-nav = Criação da estrutura de uma navbar-nav-->

        <div class="navbar-nav w-100">


          <!-- nav-link = Criação da estrutura de um link de uma navbar-nav -->

          <a href="../pages/home.php"
             class="nav-link active"
          >Home
          </a>
          <a href="../pages/galeria.php"
             class="nav-link active"
          >Galeria
          </a>
          <a href="../cads/cad_endereco_auxiliar.php"
             class="nav-link active"
          >Novo Endereço Auxiliar
          </a>
          <a href="../cads/cad_agendamento.php"
             class="nav-link active"
          >Agendamento
          </a>
        </div>

        <div class="navbar-nav">
          <a  href="../login/login.php"
              class="nav-link active"
          >Login
          </a>
        </div>

      </div>

    </div>

  </nav>

</header>

<main>

  <div class="container">

    <article class="mt-2 mb-5">

      <h1>Agendar consulta</h1>

      <form method="post" class="mt-2">

        <div class="row">

          <div class="mb-3 form-floating">
            <input type="text" class="form-control" id="nome" name="nome" placeholder="Nome" required>
            <label for="nome" class="form-label">Nome</label>
          </div>

          <div class="mb-3 form-floating">
            <input type="email" class="form-control" id="email" name="email" placeholder="E-mail" required>
            <label for="email" class="form-label">E-mail</label>
          </div>

          <div class="mb-3 form-floating">
            <input type="tel" class="form-control" id="telefone" name="telefone" placeholder="telefone" required>
            <label for="telefone" class="form-label">Telefone </label>
          </div>

          <div class="mb-3 col-md-6 form-floating">
            <select id="especialidade_medica" class="form-select" name="especialidade_medica" required>
              <option value="">&nbsp;</option>
              <option th:each="esp : ${esps}" th:value="${esp}" th:text="${esp}"></option>
            </select>
            <label for="especialidade_medica" class="form-label">Especialidade Médica</label>
          </div>

          <div class="mb-3 col-md-6 form-floating">
            <select id="nome_do_medico" class="form-select" name="nome_do_medico" required>
              <option value="">&nbsp;</option>
            </select>
            <label for="nome_do_medico" class="form-label">Nome do médico</label>
          </div>

          <input type="text" id="id_doctor" name="id_doctor" hidden >

          <div class="mb-3 col-md-6 form-floating">
            <input type="date" class="form-control" id="data_consulta" name="data_consulta"  >
            <label for="data_consulta" class="form-label">Data da consulta</label>
          </div>

          <div class="mb-3 col-md-6 form-floating">
            <select id="hora_consulta" class="form-select" name="hora_consulta" required>
              <option value="">&nbsp;</option>
            </select>
            <label for="hora_consulta" class="form-label">Horário Disponível</label>
            <input type="time" id="hora_consulta_input" name="hora_consulta" hidden >

          </div>
          <div class="text-center">
            <button type="submit" class="btn text-white">Cadastrar</button>
          </div>

          <div class="mt-3 mb-2">

            <p class="text-center text-success">Consulta agendada com sucesso</p>

            <p class="text-center text-danger">Falha no cadastro, tente novamente</p>

            <p class="text-center text-warning">Falha no cadastro: E-mail duplicado</p>

          </div>

        </div>

      </form>

    </article>

  </div>

</main>

<footer class="footer d-none d-md-block">

  <p>Copyright &copy; 2020. Todos os direitos reservados.</p>

</footer>


<footer class="d-md-none">

  <p>Copyright &copy; 2020. Todos os direitos reservados.</p>

</footer>

<footer class="footer">

  <p>Copyright &copy; 2020. Todos os direitos reservados.</p>

</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-popRpmFF9JQgExhfw5tZT4I9/CI5e2QcuUZPOVXb1m7qUmeR2b50u+YFEYe1wgzy" crossorigin="anonymous"></script>

<script>

  document.getElementById("hora_consulta").onclick = function (){

    let hora_consulta = document.getElementById("hora_consulta").value;
    document.getElementById("hora_consulta_input").setAttribute("value", hora_consulta);

  }

  let inputEspMed = document.querySelector("#especialidade_medica");
  inputEspMed.onchange = () => findDoctors(inputEspMed.value);

  function findDoctors(espMed) {

      let select = document.getElementById("nome_do_medico");
      let url = 'http://localhost:8080/find_doctors/'+espMed;

      //A api fetch busca uma resposta na url

      fetch(url)

              .then(response => {

                // A requisição finalizou com sucesso.

                if (response.ok) {

                  // Converte a string JSON para um objeto JS
                  // A execução prosseguirá para o próximo .then

                  return response.json();

                } else {

                  // A execução será deslocada para o bloco 'catch'
                  return Promise.reject(response);
                }

              })

              .then(doctors => {

                //Redefime p select

                let options = document.querySelectorAll('#nome_do_medico option');
                options.forEach(option => option.remove());

                let option = new Option("", "&nbsp");
                select.add(option, select.options[0]);

                doctors.forEach((doctor)=>{

                  option = new Option(doctor.nome, doctor.id_people);
                  select.add(option, select.options[1]);

                })

              })

              .catch(error => {

                // Ocorreu um erro na comunicação com o servidor ou
                // no processamento da requisição no JAVA, que pode não
                // ter retornado uma string JSON válida

                //Redefine o select

                let options = document.querySelectorAll('#nome_do_medico option');
                options.forEach(option => option.remove());
                let option = new Option("", "&nbsp");
                select.add(option, select.options[0]);

                select = document.getElementById("hora_consulta");
                options = document.querySelectorAll('#hora_consulta option');
                options.forEach(option => option.remove());
                option = new Option("", "&nbsp");
                select.add(option, select.options[0]);

                console.warn('Falha inesperada: ', error);

              });
    }


  document.getElementById("nome_do_medico").onchange = () => {

    let id_doctor = document.getElementById("nome_do_medico").value;
    document.getElementById("id_doctor").setAttribute("value", id_doctor);

    let select = document.getElementById("hora_consulta");
    let url = 'http://localhost:8080/find_schedules/'+id_doctor;

    //A api fetch busca uma resposta na url

    fetch(url)

            .then(response => {

              // A requisição finalizou com sucesso.

              if (response.ok) {

                // Converte a string JSON para um objeto JS
                // A execução prosseguirá para o próximo .then

                return response.clone().json();

              } else {

                // A execução será deslocada para o bloco 'catch'
                return Promise.reject(response);
              }

            })

            .then(schedules => {

              //Redefime p select

              let options = document.querySelectorAll('#hora_consulta option');
              options.forEach(option => option.remove());

              let option = new Option("", "&nbsp");
              select.add(option, select.options[0]);

              let horarios_disponiveis = [];
              for(let i=8; i <= 17; i++){
                if(i=== 8 || i === 9){
                  horarios_disponiveis.push("0"+i+":"+"00");
                }else {
                  horarios_disponiveis.push(i + ":" + "00");
                }
              }

              schedules.scheduleList.forEach((schedule)=> {

                horarios_disponiveis.forEach(h => {

                  if (h+":"+"00" === schedule.hora_consulta) {

                    horarios_disponiveis = horarios_disponiveis.filter(ha => ha !== h);

                  }

                })

              })

                for(let i=0; i < horarios_disponiveis.length; i++){

                  option = new Option(horarios_disponiveis[i], horarios_disponiveis[i]);
                  select.add(option, select.options[select.length+1]);

                }

            })

            .catch(error => {

              // Ocorreu um erro na comunicação com o servidor ou
              // no processamento da requisição no JAVA, que pode não
              // ter retornado uma string JSON válida

              //Redefine o select

              let options = document.querySelectorAll('#hora_consulta option');
              options.forEach(option => option.remove());
              let option = new Option("", "&nbsp");
              select.add(option, select.options[0]);
              console.warn('Falha inesperada: g', error);

            });


  }



</script>


</body>
</html>







